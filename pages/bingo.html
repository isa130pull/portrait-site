<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>🎯セトリビンゴ</title>
  <meta name="description" content="3×3のビンゴカードを作成・共有できるツール。編集モード・ビンゴモード搭載。画像保存、リンク共有に対応。" />
  <link rel="canonical" href="https://isa130pull.github.io/portrait-site/pages/bingo.html" />

  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="../images/bingo/favicon.ico">
  <link rel="icon" type="image/png" sizes="96x96" href="../images/bingo/favicon-96x96.png">
  <link rel="apple-touch-icon" sizes="180x180" href="../images/bingo/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="192x192" href="../images/bingo/web-app-manifest-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="../images/bingo/web-app-manifest-512x512.png">

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&family=Yusei+Magic&family=Zen+Kurenaido&family=Hachi+Maru+Pop&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: #0b0c0f;
      --fg: #e8eaed;
      --muted: #a1a7b3;
      --accent: #6ee7ff;
      --card: #14161a;
      --border: #1f2329;
      --maxw: 1024px;
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#ffffff; --fg:#111318; --muted:#5a6472; --card:#f7f8fa; --border:#e5e7eb; --accent:#0ea5e9; }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.6 system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic UI", sans-serif}
    .wrap{max-width:var(--maxw);margin:0 auto;padding:24px}
    header{padding:24px 0;margin-bottom:24px}
    .back-link{display:inline-block;margin-bottom:16px;padding:8px 16px;border:1px solid var(--border);border-radius:8px;color:var(--fg);text-decoration:none}
    .back-link:hover{border-color:var(--accent);text-decoration:none}
    h1{font-size:clamp(24px, 4vw, 32px);margin:0;font-weight:700;letter-spacing:.02em}
    .lead{color:var(--muted);margin:16px 0;line-height:1.6}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px;margin-bottom:24px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .row > *{margin:4px 0}
    .seg{display:inline-flex;background:var(--card);border:1px solid var(--border);border-radius:999px;overflow:hidden}
    .seg input{display:none}
    .seg label{padding:8px 16px;color:var(--muted);cursor:pointer;font-size:14px}
    .seg input:checked + label{background:var(--accent);color:var(--bg);font-weight:600}
    button, .ghost{appearance:none;border:1px solid var(--border);background:var(--card);color:var(--fg);padding:10px 16px;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500;transition:border-color .2s}
    button:hover{border-color:var(--accent)}
    button.primary{background:var(--accent);color:var(--bg);border-color:var(--accent);font-weight:600}
    .ghost{color:var(--muted)}
    .grid{display:grid;gap:8px;margin-top:20px}
    .cell{background:var(--bg);border:1px solid var(--border);border-radius:12px;position:relative;overflow:hidden;transition:all .2s ease}
    .cell.filled{background:color-mix(in oklab, var(--accent), transparent 95%);border-color:color-mix(in oklab, var(--accent), transparent 70%)}
    .cell.focused{border-color:var(--accent);box-shadow:0 0 0 2px color-mix(in oklab, var(--accent), transparent 85%)}
    .cell textarea{width:100%;height:100%;background:transparent;border:0;outline:none;color:var(--fg);padding:10px;text-align:center;font-weight:600;font-size:15px;resize:none;overflow:hidden;font-family:inherit;word-break:break-word;line-height:1.3}
    .cell textarea:disabled{pointer-events:none}
    .mark{position:absolute;inset:0;opacity:0;transition:.2s ease;display:flex;align-items:center;justify-content:center;pointer-events:none}
    .cell.marked .mark{opacity:1}
    .mark::before{content:'';position:absolute;width:auto;height:70%;aspect-ratio:1;background:transparent;border:6px solid #ff3b3b;border-radius:50%;transform:rotate(-12deg);box-shadow:0 4px 12px rgba(255,59,59,0.4)}
    .cell .tick{display:none}
    .footer{display:flex;gap:8px;justify-content:space-between;align-items:center;margin-top:16px;color:var(--muted);font-size:13px}
    .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:var(--card);color:var(--fg);border:1px solid var(--border);padding:12px 18px;border-radius:10px;opacity:0;pointer-events:none;transition:.2s;box-shadow:0 4px 12px rgba(0,0,0,.3)}
    .toast.show{opacity:1}
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:1000;backdrop-filter:blur(4px)}
    .modal-overlay.show{display:flex}
    .modal-dialog{background:var(--card);border:1px solid var(--border);border-radius:16px;max-width:400px;width:90%;box-shadow:0 8px 32px rgba(0,0,0,.5);animation:modalFadeIn .2s ease}
    @keyframes modalFadeIn{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}
    .modal-header{padding:20px 24px 16px;border-bottom:1px solid var(--border)}
    .modal-header h3{margin:0;font-size:18px;font-weight:600;color:var(--fg)}
    .modal-body{padding:20px 24px}
    .modal-body p{margin:0;color:var(--fg);line-height:1.6}
    .modal-footer{padding:16px 24px;display:flex;gap:12px;justify-content:flex-end;border-top:1px solid var(--border)}
    .modal-footer button{min-width:80px}
    canvas{display:none}
    footer{margin-top:64px;padding:24px 0;border-top:1px solid var(--border);color:var(--muted);font-size:14px;text-align:center}
    @media (max-width: 480px){
      .cell textarea{padding:8px 6px}
      .grid{gap:6px}
    }
  </style>

  <!-- Firebase Analytics -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAnalytics, logEvent } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCNXbUt440aa0cMaNS8nN-vHHbsgRMn9-A",
      authDomain: "portal-site-38285.firebaseapp.com",
      projectId: "portal-site-38285",
      storageBucket: "portal-site-38285.firebasestorage.app",
      messagingSenderId: "398085669341",
      appId: "1:398085669341:web:dc3db9c8d32174b3e87634",
      measurementId: "G-CF20TVK6DP"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);

    logEvent(analytics, 'page_view', {
      page_title: document.title,
      page_location: window.location.href,
      page_path: window.location.pathname
    });
  </script>
</head>
<body>
<div class="wrap">
  <header>
    <a href="../index.html" class="back-link">← トップページに戻る</a>
    <h1>🎯 セトリビンゴ</h1>
  </header>

  <section class="card">
    <div class="form-group" style="margin-bottom:20px">
      <label for="title" style="display:block;font-weight:600;margin-bottom:8px;font-size:15px">ビンゴタイトル</label>
      <input type="text" id="title" placeholder="例：セトリビンゴ" style="width:100%;padding:10px 14px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--fg);font-size:15px;font-family:inherit">
    </div>

    <div class="form-group" style="margin-bottom:20px">
      <label for="fontSelect" style="display:block;font-weight:600;margin-bottom:8px;font-size:15px">フォント（画像保存時）</label>
      <select id="fontSelect" style="width:100%;padding:10px 14px;background:var(--card);border:1px solid var(--border);border-radius:8px;color:var(--fg);font-size:15px;font-family:inherit;appearance:none;background-image:url('data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2712%27 height=%2712%27 viewBox=%270 0 12 12%27%3E%3Cpath fill=%27%23a1a7b3%27 d=%27M6 9L1 4h10z%27/%3E%3C/svg%3E');background-repeat:no-repeat;background-position:right 12px center;padding-right:40px">
        <option value="system">システム標準</option>
        <option value="pop" selected>ポップ体〔油性マジック〕</option>
        <option value="maru">丸ゴシック〔こすぎまる〕</option>
        <option value="zen">ペン書き風〔ZEN紅道〕</option>
        <option value="hachi">丸文字風〔はちまるポップ〕</option>
      </select>
    </div>

    <div class="row" style="justify-content:space-between;margin-bottom:16px">
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="shuffleBtn" class="ghost">シャッフル</button>
      </div>
      <div class="seg" role="tablist" aria-label="Mode">
        <input type="radio" name="mode" id="edit" checked><label for="edit">編集</label>
        <input type="radio" name="mode" id="play"><label for="play">ビンゴ</label>
      </div>
    </div>

    <div id="board" class="grid"></div>

    <div style="margin-top:20px;display:flex;gap:12px;flex-wrap:wrap;justify-content:space-between;align-items:center">
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="resetBtn" class="ghost">リセット</button>
        <button id="shareLink">共有URL</button>
        <button id="exportPng" class="primary">画像保存</button>
      </div>
      <small id="status" style="color:var(--muted)"></small>
    </div>
  </section>
</div>

<div class="toast" id="toast"></div>

<!-- カスタム確認ダイアログ -->
<div class="modal-overlay" id="confirmModal">
  <div class="modal-dialog">
    <div class="modal-header">
      <h3 id="modalTitle">確認</h3>
    </div>
    <div class="modal-body">
      <p id="modalMessage"></p>
    </div>
    <div class="modal-footer">
      <button id="modalCancel" class="ghost">キャンセル</button>
      <button id="modalConfirm" class="primary">OK</button>
    </div>
  </div>
</div>

<canvas id="off"></canvas>

<footer>
  <p>© <span id="y"></span> かわぐち (isa130pull)</p>
</footer>

<script>
// ===== Utilities =====
const $ = (q)=>document.querySelector(q);
const boardEl = $('#board');
const statusEl = $('#status');
const titleInput = $('#title');
const toast = $('#toast');
const off = $('#off');

function showToast(msg){
  toast.textContent = msg; toast.classList.add('show');
  setTimeout(()=>toast.classList.remove('show'), 1600);
}

// カスタム確認ダイアログ
function showConfirm(title, message){
  return new Promise((resolve)=>{
    const modal = $('#confirmModal');
    const modalTitle = $('#modalTitle');
    const modalMessage = $('#modalMessage');
    const confirmBtn = $('#modalConfirm');
    const cancelBtn = $('#modalCancel');

    modalTitle.textContent = title;
    modalMessage.textContent = message;
    modal.classList.add('show');

    function cleanup(){
      modal.classList.remove('show');
      confirmBtn.removeEventListener('click', onConfirm);
      cancelBtn.removeEventListener('click', onCancel);
      modal.removeEventListener('click', onOverlayClick);
    }

    function onConfirm(){
      cleanup();
      resolve(true);
    }

    function onCancel(){
      cleanup();
      resolve(false);
    }

    function onOverlayClick(e){
      if(e.target === modal){
        cleanup();
        resolve(false);
      }
    }

    confirmBtn.addEventListener('click', onConfirm);
    cancelBtn.addEventListener('click', onCancel);
    modal.addEventListener('click', onOverlayClick);
  });
}

// UTF-8 safe base64 for shorter share links
const b64u = {
  enc: (str)=>{
    const u8 = new TextEncoder().encode(str);
    let bin = ''; for (const b of u8) bin += String.fromCharCode(b);
    return btoa(bin).replaceAll('+','-').replaceAll('/','_').replace(/=+$/,'');
  },
  dec: (s)=>{
    s = s.replaceAll('-','+').replaceAll('_','/');
    const pad = s.length % 4 === 0 ? '' : '='.repeat(4 - (s.length % 4));
    const bin = atob(s + pad);
    const u8 = new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) u8[i]=bin.charCodeAt(i);
    return new TextDecoder().decode(u8);
  }
};

// ===== State =====
const defaultTitle = 'ビンゴ';
const BOARD_SIZE = 3;

// フォント定義
const fontMap = {
  system: {
    primary: 'system-ui',
    fallback: 'system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", sans-serif'
  },
  maru: {
    primary: 'Kosugi Maru',
    fallback: '"Kosugi Maru", "Hiragino Maru Gothic ProN", "Yu Gothic UI", sans-serif'
  },
  pop: {
    primary: 'Yusei Magic',
    fallback: '"Yusei Magic", "Hiragino Sans", "Yu Gothic", sans-serif'
  },
  zen: {
    primary: 'Zen Kurenaido',
    fallback: '"Zen Kurenaido", "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif'
  },
  hachi: {
    primary: 'Hachi Maru Pop',
    fallback: '"Hachi Maru Pop", "Hiragino Maru Gothic ProN", "Yu Gothic UI", cursive'
  }
};

let state = {
  id: null,
  cells: Array.from({length:BOARD_SIZE},()=>Array(BOARD_SIZE).fill('')),
  marked: Array.from({length:BOARD_SIZE},()=>Array(BOARD_SIZE).fill(false)),
  title: defaultTitle,
  font: 'pop',
  version: 1,
  mode: 'edit',
};

function setMode(m){
  state.mode = m;
  render();
  saveLocal();

  // 編集モードに切り替えたら最初の空白マスにフォーカス
  if(m === 'edit') {
    setTimeout(()=> focusFirstEmptyCell(), 100);
  }
}

async function resetBoard(){
  const confirmed = await showConfirm('ビンゴカードのリセット', '入力内容がすべて削除されます。よろしいですか？');
  if(!confirmed) return;
  state.cells = Array.from({length:BOARD_SIZE},()=>Array(BOARD_SIZE).fill(''));
  state.marked = Array.from({length:BOARD_SIZE},()=>Array(BOARD_SIZE).fill(false));
  state.title = defaultTitle;
  titleInput.value = defaultTitle;
  render();
  saveLocal();
  showToast('リセットしました');
}

function shuffleCells(){
  // 空でないセルのみを取得
  const filledCells = [];
  for(let r=0; r<BOARD_SIZE; r++){
    for(let c=0; c<BOARD_SIZE; c++){
      if(state.cells[r][c] && state.cells[r][c].trim()){
        filledCells.push(state.cells[r][c]);
      }
    }
  }

  if(filledCells.length === 0){
    showToast('シャッフルする内容がありません');
    return;
  }

  // Fisher-Yatesアルゴリズムでシャッフル
  for(let i = filledCells.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [filledCells[i], filledCells[j]] = [filledCells[j], filledCells[i]];
  }

  // シャッフルした結果を配置
  let index = 0;
  for(let r=0; r<BOARD_SIZE; r++){
    for(let c=0; c<BOARD_SIZE; c++){
      if(state.cells[r][c] && state.cells[r][c].trim()){
        state.cells[r][c] = filledCells[index];
        index++;
      }
    }
  }

  // マークをクリア
  state.marked = Array.from({length:BOARD_SIZE},()=>Array(BOARD_SIZE).fill(false));

  render();
  saveLocal();
  showToast('シャッフルしました');
}

function serialize(){
  if(!state.id) state.id = crypto.randomUUID();
  return JSON.stringify({
    id: state.id,
    cells: state.cells,
    marked: state.marked,
    title: state.title,
    font: state.font,
    version: state.version
  });
}

function loadFrom(obj){
  state.id = obj.id || null;
  state.cells = obj.cells;
  state.marked = obj.marked;
  state.title = obj.title || defaultTitle;
  state.font = obj.font || 'pop';
  state.version = obj.version || 1;
  titleInput.value = state.title;
  $('#fontSelect').value = state.font;
  render();
}

// ===== UI =====
function render(){
  const n = BOARD_SIZE;
  boardEl.style.gridTemplateColumns = `repeat(${n},1fr)`;
  boardEl.innerHTML = '';

  for(let r=0;r<n;r++){
    for(let c=0;c<n;c++){
      const cell = document.createElement('div');

      // 入力済みかどうかの判定
      const isFilled = state.cells[r][c] && state.cells[r][c].trim() !== '';
      cell.className = 'cell'
        + (state.marked[r][c] ? ' marked' : '')
        + (isFilled ? ' filled' : '');

      cell.dataset.r=r; cell.dataset.c=c;

      const input = document.createElement('textarea');
      input.value = state.cells[r][c] || '';
      input.maxLength = 40;
      input.dataset.index = r * n + c;  // インデックスを保存
      input.rows = 1;

      // textareaの高さを自動調整
      function adjustHeight(textarea){
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
      }

      // IME変換中かどうかのフラグ
      let isComposing = false;

      input.addEventListener('compositionstart', ()=>{
        isComposing = true;
      });

      input.addEventListener('compositionend', ()=>{
        isComposing = false;
      });

      input.addEventListener('input', (e)=>{
        state.cells[r][c] = e.target.value;
        adjustHeight(e.target);  // 高さ調整
        saveLocal();
        updateProgress();
        // 入力済みクラスの更新
        if(e.target.value.trim()) {
          cell.classList.add('filled');
        } else {
          cell.classList.remove('filled');
        }
      });

      // 初期表示時の高さ調整
      setTimeout(()=> adjustHeight(input), 0);

      // Enterキーで次のマスへ移動（IME変換中は除外）
      input.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter' && !isComposing) {
          e.preventDefault();
          focusNextCell(input.dataset.index);
        }
      });

      // フォーカス時のスタイル
      input.addEventListener('focus', ()=>{
        cell.classList.add('focused');
      });

      input.addEventListener('blur', ()=>{
        cell.classList.remove('focused');
      });

      if(state.mode==='play') input.disabled = true; else input.disabled = false;

      const mark = document.createElement('div');
      mark.className = 'mark';
      const tick = document.createElement('div'); tick.className='tick'; tick.textContent='✓';
      mark.appendChild(tick);

      cell.appendChild(input); cell.appendChild(mark);

      cell.addEventListener('click', (e)=>{
        if(state.mode === 'edit') {
          // 編集モード：inputにフォーカス
          input.focus();
        } else {
          // ビンゴモード：マークのトグル
          state.marked[r][c] = !state.marked[r][c];
          saveLocal();
          render();
        }
      });
      boardEl.appendChild(cell);
    }
  }

  updateProgress();
}

// ===== 入力支援機能 =====

// 次のマスにフォーカスを移動
function focusNextCell(currentIndex){
  const nextIndex = parseInt(currentIndex) + 1;
  const totalCells = BOARD_SIZE * BOARD_SIZE;

  if(nextIndex < totalCells) {
    const inputs = boardEl.querySelectorAll('textarea');
    if(inputs[nextIndex]) {
      inputs[nextIndex].focus();
    }
  } else {
    // 最後のマスの場合はフォーカスを外す
    document.activeElement.blur();
    showToast('入力完了！');
  }
}

// 最初の空白マスにフォーカス
function focusFirstEmptyCell(){
  if(state.mode !== 'edit') return;

  for(let r=0; r<BOARD_SIZE; r++){
    for(let c=0; c<BOARD_SIZE; c++){
      if(!state.cells[r][c] || state.cells[r][c].trim() === ''){
        const index = r * BOARD_SIZE + c;
        const inputs = boardEl.querySelectorAll('textarea');
        if(inputs[index]) {
          inputs[index].focus();
          return;
        }
      }
    }
  }

  // すべて入力済みの場合は最初のマスにフォーカス
  const inputs = boardEl.querySelectorAll('textarea');
  if(inputs[0]) inputs[0].focus();
}

// 入力進捗を更新
function updateProgress(){
  let filledCount = 0;
  const totalCells = BOARD_SIZE * BOARD_SIZE;

  for(let r=0; r<BOARD_SIZE; r++){
    for(let c=0; c<BOARD_SIZE; c++){
      if(state.cells[r][c] && state.cells[r][c].trim() !== ''){
        filledCount++;
      }
    }
  }

  const progressText = `${filledCount}/${totalCells} 入力済み`;
  statusEl.textContent = state.mode === 'edit'
    ? `${progressText} | モード: 編集`
    : `モード: ビンゴ`;
}

// ===== Local persistence =====
const LS_KEY = 'bingo.saved.v1';
function saveLocal(){ try{ localStorage.setItem(LS_KEY, serialize()); }catch(e){} }
function loadLocal(){ try{ const j = localStorage.getItem(LS_KEY); if(j){ loadFrom(JSON.parse(j)); } }catch(e){} }

// ===== PNG export (Canvas 2D) =====
// モバイルデバイス判定
function isMobileDevice() {
  const hasTouchScreen = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
  const isSmallScreen = window.innerWidth <= 900; // タブレットも考慮
  return hasTouchScreen && isSmallScreen;
}

async function exportPNG(){
  // フォント読み込み待機
  const fontConfig = fontMap[state.font] || fontMap.pop;
  const primaryFont = fontConfig.primary;
  const fallbackFont = fontConfig.fallback;

  try {
    // 主要フォントのみをロード
    await document.fonts.load(`80px "${primaryFont}"`);
    // 追加の待機時間を設けてフォントが確実に適用されるようにする
    await new Promise(resolve => setTimeout(resolve, 100));
  } catch(e) {
    console.warn('Font load failed, using fallback', e);
  }

  const px = 2048; const topMargin = 180; const sideMargin = 80; const gridStroke = 8;
  const n = BOARD_SIZE; const gridSize = px - sideMargin*2; const cell = gridSize / n;
  const gridTop = topMargin;

  off.width = px; off.height = px + topMargin; const ctx = off.getContext('2d');
  ctx.clearRect(0,0,px,px+topMargin);
  ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,px,px+topMargin);

  // タイトル描画（フォント適用）
  const title = state.title || defaultTitle;
  ctx.fillStyle = '#111';
  ctx.font = `bold 120px ${fallbackFont}`;
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText(title, px/2, topMargin/2);

  // グリッド描画
  ctx.strokeStyle = '#222'; ctx.lineWidth = gridStroke; ctx.lineCap='square';
  for(let i=0;i<=n;i++){
    const p = sideMargin + i*cell;
    ctx.beginPath(); ctx.moveTo(sideMargin, gridTop + i*cell); ctx.lineTo(sideMargin+gridSize, gridTop + i*cell); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(p, gridTop); ctx.lineTo(p, gridTop+gridSize); ctx.stroke();
  }

  // セル描画
  ctx.fillStyle = '#111';
  for(let r=0;r<n;r++){
    for(let c=0;c<n;c++){
      const x = sideMargin + c*cell, y = gridTop + r*cell;

      // まず文字を描画
      const label = (state.cells[r][c]||'').trim();
      if(label) {
        drawWrappedText(ctx, label, x, y, cell, cell, 100, fallbackFont);
      }

      // マークがある場合、丸スタンプを上から描画
      if(state.marked[r][c]){
        const centerX = x + cell/2;
        const centerY = y + cell/2;
        const radius = cell * 0.35;

        // 赤い円（枠線のみ）を描画（回転させる）
        ctx.save();
        ctx.translate(centerX, centerY);
        ctx.rotate(-12 * Math.PI / 180);
        ctx.strokeStyle = '#ff3b3b';
        ctx.lineWidth = 20;
        ctx.shadowColor = 'rgba(255, 59, 59, 0.4)';
        ctx.shadowBlur = 12;
        ctx.shadowOffsetX = 0;
        ctx.shadowOffsetY = 4;
        ctx.beginPath();
        ctx.arc(0, 0, radius, 0, Math.PI * 2);
        ctx.stroke();
        ctx.restore();

        // シャドウをリセット
        ctx.shadowColor = 'transparent';
        ctx.shadowBlur = 0;
      }
    }
  }

  off.toBlob(async (blob)=>{
    const fileName = `${state.title || 'bingo'}_${n}x${n}.png`.replace(/[\/\\?%*:|"<>]/g, '-');
    const file = new File([blob], fileName, {type:'image/png'});

    // モバイルデバイスの場合のみ共有ダイアログを表示
    if(isMobileDevice() && navigator.canShare && navigator.canShare({files:[file]})){
      try{
        await navigator.share({files:[file], title:state.title});
      }catch(e){
        // 共有がキャンセルまたは失敗した場合はダウンロード
        downloadBlob(blob, fileName);
      }
    }else{
      // PCの場合は直接ダウンロード
      downloadBlob(blob, fileName);
    }
  }, 'image/png', 1.0);
}

function drawWrappedText(ctx, text, x, y, w, h, baseSize, fontFamily){
  // Adaptive font size & wrapping
  let fontSize = baseSize; ctx.textBaseline = 'middle'; ctx.textAlign='center'; ctx.fillStyle = '#111';
  const words = splitGraphemes(text);
  // Find lines that fit
  function measure(lines){
    ctx.font = `${fontSize}px ${fontFamily}`;
    let max = 0; for(const line of lines) max = Math.max(max, ctx.measureText(line).width);
    return max;
  }
  let lines = [];
  let cur = '';
  for(const wch of words){
    const next = cur + wch; ctx.font = `${fontSize}px ${fontFamily}`;
    if(ctx.measureText(next).width > w*0.9 && cur){ lines.push(cur); cur = wch; }
    else cur = next;
  }
  if(cur) lines.push(cur);
  while(lines.length*fontSize*1.2 > h*0.9){ fontSize -= 2; if(fontSize<48) break; }
  while(measure(lines) > w*0.9){ fontSize -= 2; if(fontSize<48) break; }
  const totalH = lines.length*fontSize*1.2; let sy = y + (h-totalH)/2 + fontSize*0.8;
  for(const line of lines){ ctx.font = `${fontSize}px ${fontFamily}`; ctx.fillText(line, x + w/2, sy); sy += fontSize*1.2; }
}

function splitGraphemes(str){
  // Basic grapheme split incl. Japanese; not full ICU but good enough
  return Array.from(str);
}

function downloadBlob(blob, name){
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name; a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 2000);
  showToast('画像を保存しました');
}

// ===== リンク共有 =====
async function shareLink(){
  const data = serialize();
  const enc = b64u.enc(data);
  const url = location.origin + location.pathname + '#b=' + enc;
  try{
    await navigator.clipboard.writeText(url);
    showToast('リンクをコピーしました');
  }catch(e){
    prompt('このURLをコピーしてください', url);
  }
}

// ===== URL hash load =====
function tryLoadFromURL(){
  if(location.hash.startsWith('#b=')){
    try {
      const enc = location.hash.slice(3);
      const json = b64u.dec(enc);
      const obj = JSON.parse(json);
      loadFrom(obj);
      showToast('リンクから読み込みました');
    } catch(e){ console.warn('URL parse failed', e); }
  }
}

// ===== Events =====
$('#edit').addEventListener('change', ()=> setMode('edit'));
$('#play').addEventListener('change', ()=> setMode('play'));
$('#shuffleBtn').addEventListener('click', shuffleCells);
$('#resetBtn').addEventListener('click', resetBoard);
$('#exportPng').addEventListener('click', exportPNG);
$('#shareLink').addEventListener('click', shareLink);

// タイトル入力の監視
titleInput.addEventListener('input', (e)=>{
  state.title = e.target.value || defaultTitle;
  saveLocal();
});

// フォント選択の監視
const fontSelect = $('#fontSelect');
fontSelect.addEventListener('change', (e)=>{
  state.font = e.target.value;
  saveLocal();
});

// ===== Boot =====
loadLocal();
render();
tryLoadFromURL();

// 編集モードの場合、最初の空白マスにフォーカス
setTimeout(()=>{
  if(state.mode === 'edit') {
    focusFirstEmptyCell();
  }
}, 100);

// Footer year
document.getElementById('y').textContent = new Date().getFullYear();
</script>
</body>
</html>
